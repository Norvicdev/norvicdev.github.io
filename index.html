import asyncio
import sqlite3
import json
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
import os

# === –ù–ê–°–¢–†–û–ô–ö–ò ===
API_TOKEN = "7589951885:AAEi7nejGWQXFExoBWw2vj043oOCmUV0mNc"  # –¢–æ–∫–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä-–±–æ—Ç–∞
MANAGER_CHAT_ID = 123456789  # –í–∞—à ID (—É–∑–Ω–∞—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ @userinfobot)
WEBAPP_URL = "https://victhegeek.github.io/order_view.html"  # –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–∞
DB_FILE = "beton.db"

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ ID
last_processed_id = 0

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ ID –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
async def load_last_id():
    global last_processed_id
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT MAX(id) FROM beton")
    result = cursor.fetchone()[0]
    last_processed_id = result or 0
    conn.close()

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ ---
async def check_new_orders():
    global last_processed_id
    while True:
        try:
            conn = sqlite3.connect(DB_FILE)
            cursor = conn.cursor()
            cursor.execute("SELECT id, –ù–æ–º–µ—Ä_–∑–∞–∫–∞–∑–∞ FROM beton WHERE id > ? ORDER BY id", (last_processed_id,))
            new_orders = cursor.fetchall()
            conn.close()

            for order_id, order_number in new_orders:
                await bot.send_message(
                    chat_id=MANAGER_CHAT_ID,
                    text=f"üì¶ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑: <b>{order_number}</b>",
                    reply_markup=InlineKeyboardMarkup(
                        inline_keyboard=[
                            [InlineKeyboardButton(
                                text=f"–û—Ç–∫—Ä—ã—Ç—å –∑–∞–∫–∞–∑ {order_number}",
                                web_app=WebAppInfo(url=f"{WEBAPP_URL}?order={order_number}")
                            )]
                        ]
                    ),
                    parse_mode="HTML"
                )
                last_processed_id = order_id  # –û–±–Ω–æ–≤–ª—è–µ–º ID

            await asyncio.sleep(5)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–∞–∫–∞–∑–æ–≤: {e}")
            await asyncio.sleep(10)

# --- –ö–æ–º–∞–Ω–¥–∞ /start ---
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    await message.answer("‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä-–±–æ—Ç –∑–∞–ø—É—â–µ–Ω. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–∞—Ö –≤–∫–ª—é—á–µ–Ω—ã.")

# --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---
async def main():
    await load_last_id()
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–∫–∞–∑–æ–≤ –≤ —Ñ–æ–Ω–µ
    asyncio.create_task(check_new_orders())
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
